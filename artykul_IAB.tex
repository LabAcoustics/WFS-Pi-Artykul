% !TeX spellcheck = pl_PL
\documentclass[10pt, a4paper]{article}
\usepackage[lmargin=40mm, rmargin=40mm, tmargin=52mm, bmargin=52mm, foot=0mm, head=0mm]{geometry}
\setlength{\parindent}{10mm}

% Lista wszystkich języków stanowiących języki pozycji bibliograficznych użytych w pracy.
% (Zgodnie z zasadami tworzenia bibliografii każda pozycja powinna zostać utworzona zgodnie z zasadami języka, w którym dana publikacja została napisana.)
\usepackage[english,polish]{babel}

% Użyj polskiego łamania wyrazów (zamiast domyślnego angielskiego).
\usepackage{polski}

\usepackage[utf8]{inputenc}

% dodatkowe pakiety
\usepackage{mathtools}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{bm}
\usepackage{adjustbox}
\usepackage[dvipsnames]{xcolor}
% \usepackage{textcomp}

% obrazki
\usepackage{graphicx}
\usepackage{rotating}
\usepackage[font=small, labelfont=bf, labelsep=period]{caption}
\usepackage{subcaption}
\usepackage{float}
\captionsetup{justification=centering}

% --- < bibliografia > ---

\usepackage{placeins}	% poprawia float

\let\Oldsection\section
\renewcommand{\section}{\FloatBarrier\Oldsection}

\let\Oldsubsection\subsection
\renewcommand{\subsection}{\FloatBarrier\Oldsubsection}

\let\Oldsubsubsection\subsubsection
\renewcommand{\subsubsection}{\FloatBarrier\Oldsubsubsection}

\usepackage[explicit]{titlesec}
\titleformat{\section}[block]
{\large\centering}{\thesection. \MakeUppercase{#1}}{0ex}{}
\titlespacing{\section}{0pt}{11pt plus 0pt minus 1pt}{11pt plus 0pt minus 1pt}
\titleformat{\subsection}[block]
{\normalsize\centering}{\thesubsection. \MakeUppercase{#1}}{0ex}{}
% \titlespacing{\subsection}{8pt}{8pt}{2.5mm}


\usepackage[
style=numeric,
sorting=none,
% Zastosuj styl wpisu bibliograficznego właściwy językowi publikacji.
language=autobib,
autolang=other,
% Zapisuj datę dostępu do strony WWW w formacie RRRR-MM-DD
%urldate=iso,
%seconds=true,
% Nie dodawaj numerów stron, na których występuje cytowanie
backref=false,
% Podawaj ISBN.
isbn=true,
% Nie podawaj URL-i, o ile nie jest to konieczne
url=false,
% Ustawienia związane z polskimi normami dla bibliografii
maxbibnames=6,
minbibnames=6,
% Jeżeli używamy Bibera:
backend=biber
]{biblatex}

\AtBeginBibliography{
  \renewcommand\labelnamepunct{:\space}
  \renewcommand\newunitpunct{\addcomma\space}
  \renewcommand{\finentrypunct}{}

  \renewcommand{\bibopenparen}{\addcomma\addspace}
  \renewcommand{\bibcloseparen}{\addspace}
}

\usepackage{csquotes}
% Ponieważ `csquotes` nie posiada polskiego stylu, można skorzystać z mocno zbliżonego stylu chorwackiego.
\DeclareQuoteAlias{croatian}{polish}


\usepackage{indentfirst}
% Przecinki do numerów
\usepackage{icomma}
% ------------------------
%---------------------------------------------------------------------------
% Ustawienia wyświetlania liczb (zgodne z polskimi zwyczajami typograficznymi)
%---------------------------------------------------------------------------
\usepackage[detect-weight=true, detect-family=true]{siunitx}
\sisetup{
    output-decimal-marker = {,},
    %	round-mode=places,
    %	round-precision=4,
    group-separator={~},
    }

% --- < listingi > ---

% Użyj czcionki kroju Times.
\usepackage{newtxtext}
\usepackage{anyfontsize}
\usepackage[all,defaultlines=2]{nowidow}

\usepackage{listings}
\lstloadlanguages{TeX}

\lstset{
  literate={ą}{{\k{a}}}1
  {ć}{{\'c}}1
  {ę}{{\k{e}}}1
  {ó}{{\'o}}1
  {ń}{{\'n}}1
  {ł}{{\l{}}}1
  {ś}{{\'s}}1
  {ź}{{\'z}}1
  {ż}{{\.z}}1
  {Ą}{{\k{A}}}1
  {Ć}{{\'C}}1
  {Ę}{{\k{E}}}1
  {Ó}{{\'O}}1
  {Ń}{{\'N}}1
  {Ł}{{\L{}}}1
  {Ś}{{\'S}}1
  {Ź}{{\'Z}}1
  {Ż}{{\.Z}}1,
  basicstyle=\footnotesize\ttfamily,
}

% ------------------------

\AtBeginDocument{
  \renewcommand{\tablename}{\textbf{Tabela}}
  \renewcommand{\figurename}{\textbf{Rysunek}}
}

% ------------------------
% --- < tabele > ---

\usepackage{array}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{booktabs}
\usepackage{makecell}
\usepackage[flushleft]{threeparttable}

% defines the X column to use m (\parbox[c]) instead of p (`parbox[t]`)
\newcolumntype{C}[1]{>{\hsize=#1\hsize\centering\arraybackslash}X}

% \setlength{\cftsecnumwidth}{10mm}
% \setcounter{secnumdepth}{4}
% \brokenpenalty=10000\relax

% ------------------------
% --- < do tego artykułu > ---
\sisetup{binary-units=true}
\DeclareSIUnit{\inch}{"}
\usepackage{import}

%---------------------------------------------------------
% Nazwa pliku z bibliografią
%---------------------------------------------------------
\addbibresource{bibliografia.bib}

\begin{document}

\pagestyle{empty}

\begin{center}
	\large\textbf{\MakeUppercase{Wielokanałowy system syntezy pola akustycznego oparty o mikrokomputery Raspberry Pi}}
\end{center}
\vspace{22pt}

\noindent\MakeUppercase{M. Piszak} (uczestnik Konkursu Prac Studenckich), \MakeUppercase{S.~Mikulicz, M.~Kmiecik,} \linebreak \MakeUppercase{T.~Makuch, P.~Pawlik} (opiekun naukowy)$^1$\\

\noindent$^1$ AGH Akademia Górniczo-Hutnicza im. S. Staszica w Krakowie\\

\noindent piszak@student.agh.edu.pl

\vspace{22pt}

W większości systemów reprodukcji dźwięku wrażenia słuchowe są zależne od pozycji słuchacza. Technologią pozwalającą na usunięcie tego ograniczenia jest Wave Field Synthesis (WFS, Synteza Pola Akustycznego). Dzięki odpowiedniemu przetwarzaniu sygnałów, macierz głośników pozwala na formowanie kształtu czoła fali akustycznej tak, aby symulować wirtualne źródło dźwięku w~dowolnej odległości od słuchacza, niezależnie od jego pozycji.

Wykorzystujące tę metodę systemy są zazwyczaj skomplikowane i~drogie ze względu na wymaganą dużą liczbę niezależnych kanałów przetwarzania DSP i~przetworników elektroakustycznych. Projekt obejmuje stworzenie modułowego systemu WFS opartego na mikrokomputerach Raspberry Pi oraz dedykowanych modułach wzmacniaczy klasy D~wyposażonych w~przetworniki cyfrowo-analogowe. Modułowość konstrukcji pozwala na jednoczesne niezależne przetwarzanie dużej liczby sygnałów oraz skonfigurowanie systemu w~dowolny sposób, a~także umożliwia rozszerzanie systemu o~kolejne zestawy głośników, co zwiększa dokładność syntezy.

Obok właściwego przetwarzania sygnałów w~zależności od lokalizacji źródła, głównym wyzwaniem była synchronizacja odtwarzania przez wiele niezależnych modułów RPi -- precyzja synchronizacji jest kluczowa dla jakości generowania pola akustycznego oraz percepcji zgodnej z~założeniami. Dlatego wprowadzono rozwiązanie pozwalające na synchronizację odtwarzania dźwięku przez wszystkie moduły.

Skonstruowano działający prototyp systemu, którego działanie zostało poddane weryfikacji pomiarowej. Wykonano pomiary sygnału na wyjściu każdego wzmacniacza oraz wstępne pomiary w~komorze bezechowej, pozwalające określić jakość pola akustycznego generowanego przez skonstruowany system.

\section{Cel pracy}

Celem niniejszej pracy było zaprojektowanie modułowego systemu
syntezy pola akustycznego, opartego na łatwo dostępnych komponentach
i~umożliwiającego stosunkowo prostą adaptację do wybranego zastosowania.

\section{Synteza pola akustycznego}

Metoda WFS oparta jest na zasadzie Huygensa: każdy punkt do którego dociera
fala akustyczna staje się źródłem nowej fali. Zgodnie z tą zasadą każdy głośnik
w~macierzy może być rozpatrywany zarówno jako odbiornik (punkt, do którego dociera 
fala dźwiękowa) jak i~jako źródło drugiego rzędu, reprodukujące falę pochodzącą od 
źródła wirtualnego (rys.~\ref{r:Huygens}). Dzięki odpowiedniemu przetwarzaniu sygnału głośniki emitują
falę, które nakładając się, formują czoło o~pożądanym kształcie, tworząc wrażenie
źródła zlokalizowanego w~określonym punkcie w~przestrzeni~\cite{hq_rendering}.

\begin{figure}[!tbh]
  \centering
  \begin{subfigure}[b]{.49\textwidth}
  \centering
  \includegraphics[scale=.35]{vecgraphics/WFS_idea.pdf}
  \caption{Zastosowanie zasady Huygensa w WFS: każdy głośnik jest punktem do
  którego dociera fala wyemitowana przez wirtualne źródło}
  \label{r:Huygens}
  \end{subfigure}
  ~
  \begin{subfigure}[b]{.49\textwidth}
  \centering
  \includegraphics[width=\textwidth, trim={4.2cm 0.5cm 4.5cm .5cm}, clip]{vecgraphics/symulacja200Hz.pdf}
  \caption{Symulacja rozkładu pola zaprojektowanego systemu dla fali sinusoidalnej o~częstotliwości \SI{200}{\hertz}}
  \label{r:Huygens}
  \end{subfigure}
  \caption{Ilustracja zasady działania systemu WFS}
\end{figure}

Równaniem, na którym opiera się przetwarzanie sygnałów w~WFS jest całka Helmholtza-Huygensa
(lub Kirchoffa-Helmholtza), analityczna metoda opisu rozkładu pola akustycznego,
pozwalająca wyznaczyć rozkład ciśnienia akustycznego pochodzące od danego zestawu
źródeł~\cite{snaka}. Na tej podstawie definiowana jest funkcja opisująca ciśnienie akustyczne 
w~punkcie umieszczenia każdego głośnika. To podejście pozwala uwzględnić geometrię
przestrzeni oraz straty energii podczas propagacji fali dźwiękowej i~wyznaczyć
amplitudy oraz fazy sygnału dla każdego z~głośników. 

\section{Projekt systemu}

W ramach projektowania systemu między innymi:
\begin{itemize}
  \item wybrano rozmiar macierzy głośnikowej i~dobrano odpowiednie przetworniki
    oraz dobrano pozostałe elementy systemu;
  \item zaprojektowano algorytm przetwarzania sygnałów;
  \item przeprowadzono symulacje rozkładu pola akustycznego, by zweryfikować działanie algorytmu.
\end{itemize}

\subsection{Geometria}

Rozmiar macierzy głośnikowej determinuje zakres częstotliwości, w~którym system
jest w~stanie odtwarzać dźwięk z dużą dokładnością. Przyjęte w modelu teoretycznym 
źródło liniowe jest w~rzeczywistości szeregiem dyskretnych źródeł, oddalonych od siebie 
o~odległość $\Delta x$, a~każdy głośnik ma określone wymiary. Im większa macierz, tym niższa 
jest częstotliwość która może być odtworzona, gdyż źródło jest wystarczająco duże w stosunku 
do długości fali akustycznej; musi być spełniony warunek \eqref{eq:fmin}:
\begin{equation}
  f_{min}>\frac{c}{L} \quad,	\label{eq:fmin}
\end{equation}
gdzie:\\
\indent \begin{tabular}{l c l}
  $f_{min}$ [\si{\hertz}] & --- & najniższa częstotliwość możliwa do prawidłowej syntezy, \\
  $c$ [\si[per-mode=symbol]{\metre\per\second}] & --- & prędkość propagacji fali dźwiękowej, \\
  $L$ [\si{\metre}] & --- & długość macierzy głośników. \\
\end{tabular}\\

Dla górnej granicy częstotliwości należy uwzględnić zjawisko aliasingu
przestrzennego. Odległości pomiędzy głośnikami powodują różnice fazowe, w~wyniku których 
występuje konstruktywna i~destruktywna interferencja dla częstotliwości powyżej~\eqref{eq:fmax}:

\begin{equation}
  f_{max}=\frac{c}{2\Delta x \sin{\alpha_{max}}} \quad, \label{eq:fmax}
\end{equation}
gdzie:\\
\indent \begin{tabular}{l c p{.7\textwidth}}
  $f_{max}$ [\si{\hertz}] & --- & najwyższa częstotliwość wolna od aliasingu przestrzennego, \\
  $\Delta x$ [\si{\metre}] & --- & odległość między środkami dwóch sąsiednich głośników, \\
  $\alpha_{max}$ [\si{\radian}] & --- & maksymalny kąt pomiędzy falą padającą od źródła 
wirtualnego a~macierzą głośników.\\
\end{tabular}\\

\noindent Efekt ten nie zniekształca jednak dźwięku w sposób znaczący dla odbioru przez słuchacza
~\cite{hq_rendering}.

Uwzględniając te ograniczenia, wybrano głośniki o średnicy \SI{3}{\inch}
(\SI{81}{\milli\meter}), które rozmieszczono co
$\Delta x=\SI{150}{\milli\meter}$.

\subsection{Przetwarzanie sygnałów}\label{s:algorithm}

Dla określonej geometrii układu źródło wirtualne --- macierz głośników,
korzystając z~całki Helmholtza-Huygensa, sygnał dla każdego głośnika można zapisać
w~postaci~\eqref{eq:glosnik_t}~\cite{enhancement}:

\begin{equation}
  q_n(t) = a_n\left[h(t)*s(t)*\delta(t-\tau_n)\right] \quad. \label{eq:glosnik_t}
\end{equation}

Sygnał źródła wirtualnego $s(t)$ musi zostać pomnożony przez współczynnik wagowy 
amplitudy $a_n$, spleciony z~filtrem o~transmitancji $\sqrt{\frac{j\omega}{2\pi c}}$, 
którego współczynniki są oznaczane jako $h(t)$, i~opóźniony o~$\tau_n$, stosownie do
pozycji źródła i~każdego głośnika.

\section{Realizacja}

Zastosowano rozwiązania oparte na komputerach Raspberry
Pi. Mają one niewielkie wymiary i~dysponują odpowiednią mocą obliczeniową
potrzebną do przetwarzania sygnałów wysyłanych na poszczególne kanały.

Przetwarzanie sygnału z~cyfrowego na analogowy oraz jego wzmocnienie jest
realizowane przez moduł Amp Zero pHAT firmy JustBoom. Jest to połączenie
wysokiej jakości przetwornika analogowo-cyfrowego oraz wzmacniacza klasy 
D~o~mocy wyjściowej $2\times40\si{\watt}$. Sygnał może być próbkowany 
z~częstotliwością \SI{192}{\kilo\hertz} i~rozdzielczością \SI{32}{\bit}, 
a~zastosowanie wzmacniacza klasy D~umożliwia osiąganie odpowiedniej mocy
głośników bez zużywania nadmiernej ilości energii oraz przy zachowaniu niewielkich
rozmiarów pojedynczego modułu.

Wybrano głośniki firmy Faital Pro model 3FE25
o~średnicy \SI{3}{\inch}, impedancji \SI{8}{\ohm} i~nominalnym zakresie 
częstotliwości \SI{100}{\hertz}~--~\SI{20}{\kilo\hertz}.
%których podstawowe parametry przedstawiono w tabeli \ref{tab:paramglosnik}.

% \begin{table}[!ht]
%   \centering
%   \caption{Parametry głośnika Faital Pro 3FE25}
%   \begin{tabular}{|c|c|} \hline
%     \textbf{Parametr} & \textbf{Wartość} \\ \hline
%     Średnica & \SI{3}{\inch} \\ \hline
%     Impedancja nominalna & \SI{8}{\ohm} \\ \hline
%     Moc nominalna & \SI{20}{\watt} \\ \hline
%     Skuteczność (\SI{1}{\watt} / \SI{1}{\metre}) & \SI{91}{\decibel} \\ \hline
%     Zakres częstotliwości & od \SI{100}{\hertz} do \SI{20}{\kilo\hertz} \\ \hline
%   \end{tabular}
%   \label{tab:paramglosnik}
% \end{table}

Każdy moduł składa się z~komputera Raspberry Pi, modułu wzmacniacza Amp Zero
oraz dwóch głośników.
%Ponieważ moduły wzmacniaczy oraz przetworników A/C były dwukanałowe, na każdy
%moduł oraz komputer Raspberry Pi przypadły dwa głośniki. 
Aby zwiększyć możliwości adaptacji systemu do wymaganych warunków
każdy głośnik zostanie umieszczony w~oddzielnej obudowie. Takie rozwiązanie
pozwala na manipulowanie kształtem i~rozmiarem macierzy głośników,
co jest pożądane ze względu na dydaktyczne i~naukowe zastosowania systemu.  
%aby istniała możliwość zmiany zarówno odległości jak i kąta pomiędzy
%poszczególnymi źródłami macierzy głośnikowej.
Strukturę systemu przedstawia rysunek \ref{fig:schemat}.

Aby generowane pole akustyczne było spójne, w~czasie przetwarzaniu sygnałów przez
poszczególne moduły nie mogą występować dewiacje. Dlatego system posiada połączenie
synchronizujące moment rozpoczęcia przetwarzania próbek dźwięku.
Rozwiązuje to problem nieprzewidywalnego czasu przetwarzania wobec faktu, że
zastosowane komputery nie pracują w~oparciu o~systemy czasu rzeczywistego.

\begin{figure}[H]
  \centering
  \adjustbox{max width=.7\linewidth}{\import{./vecgraphics/}{scheme3.pdf_tex}}
  \caption{Schemat projektowanego systemu WFS}
  \label{fig:schemat}
\end{figure}

Połączenie synchronizujące wykorzystuje piny GPIO. Oprogramowanie służące do
synchronizacji oraz kontroli systemu napisano w~oparciu o~język Rust, którego
zaletą jest wysoka wydajność (na poziomie języka C). Skorzystano z gotowej
biblioteki \emph{RPPAL}~\cite{RPPAL} obsługującej piny GPIO w~mikrokomputerach
Raspberry Pi. Dane audio oraz informacje na temat lokalizacji głośników i
wirtualnego źródła przesyłane są bezprzewodowo przez sieć lokalną (LAN), co
oznacza, że system nie może odtwarzać dźwięku w czasie rzeczywistym, lecz
pozwala na wygodne modyfikacje układu przestrzennego i zmniejsza ilość
przewodów. Główna jednostka systemu z aplikacją serwera kontroluje połączenie
synchronizujące oraz zarządza procesorami przetwarzania audio. To pozwala na rozszerzanie
systemu w~przyszłości i~zwiększanie jego funkcjonalności.

\section{Podsumowanie}

Zaprojektowany system dzięki swojej modułowości pozwala na różnorodność
zastosowań, w zależności od pożądanego rozmiaru macierzy głośnikowej,
pozwalając użytkownikowi na wybór najodpowiedniejszej konfiguracji. Jest
ponadto bardziej ekonomiczny niż system korzystający z dedykowanych procesorów
przetwarzania sygnałów.

Obecnie system jest w fazie testowania i dalszego rozwoju, więc jego końcowe
działanie zostanie zweryfikowane w~kolejnych etapach badań.

Zastosowania WFS sięgają od tworzenia wrażeń przestrzennych, poprzez poprawę
jakości akustyki pomieszczeń~\cite{enhancement}, do badań psychoakustycznych,
oraz dydaktyki --- zaprojektowany system można dostosować do każdego z~nich.
Ponadto może być on użyty do dalszego badania możliwości i ograniczeń syntezy
pola akustycznego.

\printbibliography

\end{document}
